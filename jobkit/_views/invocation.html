{{ define "invocation" }}
{{ template "header" . }}
<div id="content" class="uk-container uk-container-expand">
	<div class="uk-child-width-expand@s" uk-grid>
		<div>
			<ul class="uk-breadcrumb">
				<li><a href="/">Jobs</a></li>
				<li><a href="/search?selector=name={{ .ViewModel.JobName }}">{{ .ViewModel.JobName }}</a></li>
				<li><span>{{ .ViewModel.ID }}</span></li>
			</ul>
		</div>
		<div class="uk-flex-right uk-text-right">
			<a class="uk-button" href="/api/job.invocation.output/{{ .ViewModel.JobName }}/{{ .ViewModel.ID }}">JSON</a>
			<a class="uk-button" href="/job.invocation.output/{{ .ViewModel.JobName }}/{{ .ViewModel.ID }}">Raw</a>
			<a class="uk-button" href="/api/job.invocation.output.stream/{{ .ViewModel.JobName }}/{{ .ViewModel.ID }}">Stream</a>
		</div>
	</div>
	<table class="uk-table">
		<thead>
			<tr>
				<th>Status</th>
				<th>Started</th>
				<th>Finished</th>
				<th>Elapsed</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>
					{{ if .ViewModel.Status | eq "running" }}
					<div uk-tooltip="Job is currently running" uk-spinner="ration: 0.5"></div>
					{{ else if .ViewModel.Status | eq "cancelled" }}
					<span class="uk-text-warning" uk-icon="warning" uk-tooltip="Job was last cancelled"></span>
					{{ else if.ViewModel.Status | eq "failed" }}
					<span class="uk-text-danger" uk-icon="warning" uk-tooltip="Job had a failure"></span>
					{{ else if .ViewModel.Status | eq "complete" }}
					<span class="uk-text-success" uk-icon="check" uk-tooltip="Last invocation was a success"></span>
					{{ end }}
				</td>
				<td>{{ .ViewModel.Started | rfc3339 }}</td>
				<td>{{ if .ViewModel.Finished.IsZero }}-{{ else }}{{ .ViewModel.Finished | rfc3339 }}{{ end }}</td>
				<td>{{ if .ViewModel.Finished.IsZero }}{{ .ViewModel.Started | since_utc }}{{ else }}{{ .ViewModel.Elapsed }}{{ end }}</td>
			</tr>
		</tbody>
	</table>
	{{ if .ViewModel.Err }}
	<table class="uk-table">
		<thead>
			<tr>
				<th>Error</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>
					<code>{{ .ViewModel.Err }}</code>
				</td>
			</tr>
		</tbody>
	</table>
	{{ end }}
	<table class="uk-table">
		<thead>
			<tr>
				<th>Output (Combined)</th>
			</tr>
		</thead>
		<tbody>
			<tr>
				<td>
				<link rel="stylesheet" href="/static/css/xterm.css" />
				<script src="/static/js/xterm.js"></script>
				<script src="/static/js/fit.js"></script>
				<script src="/static/js/webLinks.js"></script>

				<div id="term-window"></div>
				<script>
					Terminal.applyAddon(fit);
					var term = new Terminal();
					term.open(document.getElementById('term-window'));
					term.cols = 240;
					term.resize();
					term.markers = [];
					/* code {{ range $index, $line := .ViewModel.Output.Lines }} */
					term.writeln("{{ $line.Data | as_string }}");
					/*{{ end }}*/
					/* {{ if .ViewModel.Status | eq "running" }} */
					var es = new EventSource("/api/job.invocation.output.stream/{{ .ViewModel.JobName }}/{{ .ViewModel.ID }}");
					es.onmessage = (e) => {
						term.writeln(e.data);
					};
					/*{{ end }}*/
				</script>
				</td>
			</tr>
		</tbody>
	</table>
</div>
{{ template "footer" . }}
{{ end }}