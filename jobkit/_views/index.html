{{ define "index" }}
{{ template "header" . }}
<div id="content" class="uk-container uk-container-expand">
	<table class="uk-table uk-table-small uk-table-divider">
		<thead>
			<tr>
				<th></th>
				<th>Status</th>
                <th>Name</th>
				<th>Labels</th>
				<th>Success Rate</th>
				<th>P95</th>
				<th>Schedule</th>
				<th>Next Run</th>
				<th>Last Ran</th>
				<th>Last Result</th>
				<th>Last Elapsed</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
		{{ $singleResult := .ViewModel.Jobs | len | eq 1 }}
		{{ range $index, $job := .ViewModel.Jobs }}
			<tr id="{{ $job.Name }}">
				<td>
					<button id="show-{{ $job.Name }}" class="uk-button" uk-toggle="target: #history-{{ $job.Name }},#hide-{{ $job.Name }},#show-{{ $job.Name }}" type="button" uk-icon="plus-circle" {{ if $singleResult }}hidden{{ end }}></button>
					<button id="hide-{{ $job.Name }}" class="uk-button" uk-toggle="target: #history-{{ $job.Name }},#hide-{{ $job.Name }},#show-{{ $job.Name }}" type="button" uk-icon="minus-circle" {{ if $singleResult | not }}hidden{{ end }}></button>
				</td>
				<td> <!-- status -->
					{{ if $job.Current }}
					<div uk-tooltip="Job is currently running" uk-spinner="ration: 0.5"></div>
					{{ else if $job.Last }}
						{{ if $job.Last.Status | eq "cancelled" }}
						<span class="uk-text-warning" uk-icon="warning" uk-tooltip="Job was last cancelled"></span>
						{{ else if $job.Last.Status | eq "failed" }}
						<span class="uk-text-danger" uk-icon="warning" uk-tooltip="Job had a failure"></span>
						{{ else if $job.Last.Status | eq "complete" }}
						<span class="uk-text-success" uk-icon="check" uk-tooltip="Last invocation was a success"></span>
						{{ end }}
					{{ end }}
				</td>
                <td>
                    {{ $job.Name }}
                </td>
				<td> <!-- job labels-->
					<ul class="uk-list uk-list-divider">
				{{ range $key, $value := $job.Labels }}
						<li><a href="/search?selector={{ $key | urlencode }}={{ $value | urlencode }}">{{ $key }}={{ $value }}</a></li>
				{{ end }}
					</ul>
				</td>
				<td> <!-- success rate -->
					{{ if gt $job.Stats.SuccessRate 0.9 }}
					<span class="uk-text-success">
						{{ $job.Stats.SuccessRate | format_pct }}
					</span>
					{{ else if gt $job.Stats.SuccessRate 0.7 }}
					<span class="uk-text-warning">
						{{ $job.Stats.SuccessRate | format_pct }}
					</span>
					{{ else }}
					<span class="uk-text-danger">
						{{ $job.Stats.SuccessRate | format_pct }}
					</span>
					{{ end }}
				</td>
				<td> <!-- p95 -->
					{{ $job.Stats.Elapsed95th }}
				</td>
				<td> <!-- schedule -->
				{{ if $job.Schedule }}
					{{ $job.Schedule }}
				{{ else }}
					<span>-</span>
				{{ end }}
				</td>
				<td> <!-- next run-->
				{{ if $job.Disabled }}
					<span>-</span>
				{{ else }}
					{{ $job.NextRuntime | rfc3339 }}
				{{ end }}
				</td>
				<td> <!-- last run -->
				{{ if $job.Last }}
					{{ $job.Last.Finished | since_utc }} ago
				{{ else }}
					<span class="none">-</span>
				{{ end }}
				</td>
				<td> <!-- last status -->
				{{ if $job.Last }}
					{{ if $job.Last.Err }}
						<code>{{ $job.Last.Err }}</code>
					{{ else }}
					<span class="none">Success</span>
					{{ end }}
				{{ else }}
					<span class="none">-</span>
				{{ end }}
				</td>
				<td> <!-- last elapsed -->
				{{ if $job.Last }}
					{{ $job.Last.Elapsed }}
				{{ else }}
					<span class="none">-</span>
				{{ end }}
				</td>
				<td> <!-- actions -->
				{{ if $job.Disabled }}
					<form method="POST" action="/job.enable/{{ $job.Name }}" class="uk-form">
						<input type="submit" class="uk-button" value="Enable" />
					</form>
				{{else}}
					<form method="POST" action="/job.disable/{{ $job.Name }}" class="uk-form">
						<input type="submit" class="uk-button" value="Disable" />
					</form>
				{{end}}
				{{ if $job.CanRun }}
				<form method="POST" action="/job.run/{{ $job.Name }}" class="uk-form">
					<input type="submit" class="uk-button uk-button-primary" value="Run" />
				</form>
				{{ else }}
				<button class="uk-button uk-button-disabled" disabled>Running</button>
				{{ end }}
				</td>
			</tr>
			<tr id="history-{{ $job.Name }}" {{ if $singleResult | not }}hidden{{end}}>
				<td colspan=12>
					{{ if $job.Description }}
					<table class="uk-table">
						<tbody>
							<tr>
								<td><pre>{{ $job.Description }}</pre></td>
							</tr>
						</tbody>
					</table>
					{{ end }}
					<table class="uk-table uk-table-small uk-table-striped">
						<thead>
							<tr>
								<th>Started</th>
								<th>Finished</th>
								<th>Result</th>
								<th>Elapsed</th>
								<th>Error</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
						{{ range $key, $ji := $job.Current }}
							<tr>
								<td>{{ $ji.Started | rfc3339 }}</td>
								<td>{{ if $ji.Finished.IsZero }}-{{ else }}{{ $ji.Finished | rfc3339 }}{{ end }}</td>
								<td>{{ $ji.Status }}</td>
								<td>{{ $ji.Elapsed }}</td>
								<td>{{ if $ji.Err }}<code>{{ $ji.Err }}</code>{{ else }}-{{end}}</td>
								<td><a class="uk-button"href="/job.invocation/{{$ji.JobName}}/{{ $ji.ID }}">View Output</td>
							</tr>
						{{ end }}
						{{ range $index, $ji := $job.History | reverse }}
							<tr>
								<td>{{ $ji.Started | rfc3339 }}</td>
								<td>{{ if $ji.Finished.IsZero }}-{{ else }}{{ $ji.Finished | rfc3339 }}{{ end }}</td>
								<td>{{ $ji.Status }}</td>
								<td>{{ $ji.Elapsed }}</td>
								<td>{{ if $ji.Err }}<code>{{ $ji.Err }}</code>{{ else }}-{{end}}</td>
								<td><a class="uk-button uk-button-primary" href="/job.invocation/{{$ji.JobName}}/{{ $ji.ID }}">Output</td>
							</tr>
						{{ end }}
						</tbody>
					</table>
				</td>
			</tr>
			{{ else }}
			<tr><td colspan=12>No jobs loaded or matched the search selector.</td></tr>
			{{ end }}
		</tbody>
	</table>
</div>
{{ template "footer" . }}
{{ end }}
